pipeline {
    agent any

    environment {
        ImageRegistry = "chamudim"
        COMPOSE_FILE = "Xpensify-client/docker-compose.yml"
        EC2_IP = "54.83.85.71"  // Replace with your EC2 IP
    }

    stages {
        
        stage("Deploy to AWS EC2") {
            steps {
                script {
                    echo "Deploying application on EC2..."
                    sshagent(['ec2-devops']) {
                        bat """
                        pscp ${COMPOSE_FILE} ubuntu@${EC2_IP}:/home/ubuntu
                        plink ubuntu@${EC2_IP} "docker login -u chamudim -p %chamudi-dockerhub-pass%"
                        plink ubuntu@${EC2_IP} "docker compose -f /home/ubuntu/${COMPOSE_FILE} down || true"
                        plink ubuntu@${EC2_IP} "docker compose -f /home/ubuntu/${COMPOSE_FILE} pull"
                        plink ubuntu@${EC2_IP} "docker compose -f /home/ubuntu/${COMPOSE_FILE} up --build -d"
                        """
                    }
                }
            }
        }
    }

    post {
        always {
            echo "Cleaning up workspace..."
            cleanWs()
        }
    }
}
